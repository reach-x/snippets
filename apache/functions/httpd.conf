# Apache HTTP Server configuration examples

# Server root
ServerRoot "/etc/httpd"

# Listen on port 80
Listen 80
Listen 443

# Load modules
LoadModule mpm_prefork_module modules/mod_mpm_prefork.so
LoadModule authn_file_module modules/mod_authn_file.so
LoadModule authn_core_module modules/mod_authn_core.so
LoadModule authz_host_module modules/mod_authz_host.so
LoadModule authz_groupfile_module modules/mod_authz_groupfile.so
LoadModule authz_user_module modules/mod_authz_user.so
LoadModule authz_core_module modules/mod_authz_core.so
LoadModule access_compat_module modules/mod_access_compat.so
LoadModule auth_basic_module modules/mod_auth_basic.so
LoadModule reqtimeout_module modules/mod_reqtimeout.so
LoadModule filter_module modules/mod_filter.so
LoadModule mime_module modules/mod_mime.so
LoadModule log_config_module modules/mod_log_config.so
LoadModule env_module modules/mod_env.so
LoadModule headers_module modules/mod_headers.so
LoadModule setenvif_module modules/mod_setenvif.so
LoadModule version_module modules/mod_version.so
LoadModule unixd_module modules/mod_unixd.so
LoadModule status_module modules/mod_status.so
LoadModule autoindex_module modules/mod_autoindex.so
LoadModule dir_module modules/mod_dir.so
LoadModule alias_module modules/mod_alias.so
LoadModule rewrite_module modules/mod_rewrite.so
LoadModule ssl_module modules/mod_ssl.so
LoadModule proxy_module modules/mod_proxy.so
LoadModule proxy_http_module modules/mod_proxy_http.so
LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so
LoadModule deflate_module modules/mod_deflate.so
LoadModule expires_module modules/mod_expires.so
LoadModule cache_module modules/mod_cache.so
LoadModule cache_disk_module modules/mod_cache_disk.so

# User and group
<IfModule unixd_module>
    User apache
    Group apache
</IfModule>

# Server admin email
ServerAdmin admin@example.com

# Server name
ServerName example.com:80

# Deny access to root filesystem
<Directory />
    AllowOverride none
    Require all denied
</Directory>

# Document root
DocumentRoot "/var/www/html"

<Directory "/var/www/html">
    Options Indexes FollowSymLinks
    AllowOverride All
    Require all granted
</Directory>

# Directory index files
<IfModule dir_module>
    DirectoryIndex index.html index.php index.htm
</IfModule>

# Deny access to .htaccess files
<Files ".ht*">
    Require all denied
</Files>

# Error log
ErrorLog "/var/log/httpd/error_log"
LogLevel warn

# Access log
<IfModule log_config_module>
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined
    LogFormat "%h %l %u %t \"%r\" %>s %b" common

    <IfModule logio_module>
        LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" %I %O" combinedio
    </IfModule>

    CustomLog "/var/log/httpd/access_log" combined
</IfModule>

# MIME types
<IfModule mime_module>
    TypesConfig /etc/mime.types
    AddType application/x-compress .Z
    AddType application/x-gzip .gz .tgz
    AddType text/html .shtml
    AddOutputFilter INCLUDES .shtml
</IfModule>

# Compression
<IfModule deflate_module>
    AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css
    AddOutputFilterByType DEFLATE application/javascript application/json
    AddOutputFilterByType DEFLATE application/xml application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml application/atom+xml
    AddOutputFilterByType DEFLATE image/svg+xml

    # Don't compress images
    SetEnvIfNoCase Request_URI \.(?:gif|jpe?g|png)$ no-gzip dont-vary

    # Netscape 4.x has some problems
    BrowserMatch ^Mozilla/4 gzip-only-text/html

    # Netscape 4.06-4.08 have some more problems
    BrowserMatch ^Mozilla/4\.0[678] no-gzip

    # MSIE masquerades as Netscape, but it is fine
    BrowserMatch \bMSIE !no-gzip !gzip-only-text/html
</IfModule>

# Cache control
<IfModule expires_module>
    ExpiresActive On
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    ExpiresDefault "access plus 2 days"
</IfModule>

# Security headers
<IfModule headers_module>
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
</IfModule>

# SSL Configuration
<IfModule ssl_module>
    SSLRandomSeed startup builtin
    SSLRandomSeed connect builtin

    <VirtualHost *:443>
        ServerName example.com
        ServerAlias www.example.com
        DocumentRoot "/var/www/html"

        # SSL Engine
        SSLEngine on
        SSLCertificateFile /etc/pki/tls/certs/example.com.crt
        SSLCertificateKeyFile /etc/pki/tls/private/example.com.key
        SSLCertificateChainFile /etc/pki/tls/certs/chain.crt

        # SSL Protocol and Cipher
        SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
        SSLCipherSuite HIGH:!aNULL:!MD5:!3DES
        SSLHonorCipherOrder on

        # HSTS
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

        # Logs
        ErrorLog "/var/log/httpd/ssl_error_log"
        CustomLog "/var/log/httpd/ssl_access_log" combined

        <Directory "/var/www/html">
            Options -Indexes +FollowSymLinks
            AllowOverride All
            Require all granted
        </Directory>
    </VirtualHost>
</IfModule>

# Virtual Hosts

# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName example.com
    ServerAlias www.example.com
    Redirect permanent / https://example.com/
</VirtualHost>

# Main virtual host
<VirtualHost *:443>
    ServerName example.com
    ServerAlias www.example.com
    DocumentRoot "/var/www/html"

    # Logging
    ErrorLog "/var/log/httpd/example.com-error.log"
    CustomLog "/var/log/httpd/example.com-access.log" combined

    # Directory configuration
    <Directory "/var/www/html">
        Options -Indexes +FollowSymLinks +MultiViews
        AllowOverride All
        Require all granted

        # Rewrite rules
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /

            # Force www
            RewriteCond %{HTTP_HOST} !^www\. [NC]
            RewriteRule ^(.*)$ https://www.%{HTTP_HOST}/$1 [R=301,L]

            # Remove trailing slashes
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)/$ /$1 [R=301,L]

            # Route to index.php
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule ^(.*)$ index.php?/$1 [L,QSA]
        </IfModule>
    </Directory>

    # PHP-FPM proxy
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/var/run/php-fpm.sock|fcgi://localhost"
    </FilesMatch>

    # Alias for static files
    Alias /static /var/www/static
    <Directory /var/www/static>
        Options -Indexes
        Require all granted
    </Directory>

    # Proxy to backend application
    <Location /api>
        ProxyPass http://localhost:3000/api
        ProxyPassReverse http://localhost:3000/api
        ProxyPreserveHost On
        RequestHeader set X-Forwarded-Proto "https"
        RequestHeader set X-Forwarded-Port "443"
    </Location>

    # Basic authentication
    <Location /admin>
        AuthType Basic
        AuthName "Restricted Area"
        AuthUserFile /etc/httpd/.htpasswd
        Require valid-user
    </Location>

    # IP-based access control
    <Location /internal>
        Require ip 10.0.0.0/8 192.168.0.0/16
    </Location>

    # Custom error pages
    ErrorDocument 404 /errors/404.html
    ErrorDocument 500 /errors/500.html
    ErrorDocument 503 /errors/503.html
</VirtualHost>

# Status page for monitoring
<Location /server-status>
    SetHandler server-status
    Require ip 127.0.0.1 ::1
</Location>

# Info page
<Location /server-info>
    SetHandler server-info
    Require ip 127.0.0.1 ::1
</Location>

# Limits and timeouts
Timeout 60
KeepAlive On
MaxKeepAliveRequests 100
KeepAliveTimeout 5

# MPM Prefork configuration
<IfModule mpm_prefork_module>
    StartServers 5
    MinSpareServers 5
    MaxSpareServers 10
    MaxRequestWorkers 250
    MaxConnectionsPerChild 0
</IfModule>

# Request limits
LimitRequestLine 8190
LimitRequestFieldSize 8190
LimitRequestFields 100
LimitRequestBody 10485760

# Include additional configurations
IncludeOptional conf.d/*.conf
IncludeOptional sites-enabled/*.conf

# .htaccess example (in document root)
# Options -Indexes +FollowSymLinks
#
# <IfModule mod_rewrite.c>
#     RewriteEngine On
#
#     # Force HTTPS
#     RewriteCond %{HTTPS} off
#     RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
#
#     # Remove .php extension
#     RewriteCond %{REQUEST_FILENAME} !-d
#     RewriteCond %{REQUEST_FILENAME}\.php -f
#     RewriteRule ^(.*)$ $1.php [L]
#
#     # WordPress permalinks
#     RewriteBase /
#     RewriteRule ^index\.php$ - [L]
#     RewriteCond %{REQUEST_FILENAME} !-f
#     RewriteCond %{REQUEST_FILENAME} !-d
#     RewriteRule . /index.php [L]
# </IfModule>
#
# # Cache control
# <FilesMatch "\.(jpg|jpeg|png|gif|ico|css|js|woff|woff2|ttf|svg)$">
#     Header set Cache-Control "max-age=31536000, public"
# </FilesMatch>
#
# # Deny access to sensitive files
# <FilesMatch "(^#.*#|\.(bak|conf|dist|inc|ini|log|sh|sql|sw[op])|~)$">
#     Require all denied
# </FilesMatch>
